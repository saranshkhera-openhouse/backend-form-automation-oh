<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Openhouse â€” Token Request Form</title><link rel="stylesheet" href="/css/styles.css"></head>
<body>
<header class="header"><div><div class="logo">OPENHOUSE</div><div class="subtitle">Token Request Form</div></div></header>
<div class="container">

  <div class="card">
    <div class="card-title">Load Property by UID</div>
    <div class="card-desc">Search and select a UID from completed visits.</div>
    <div class="search-row">
      <div class="fg"><label>Property UID <span class="req">*</span></label><select id="selUid" style="font-family:var(--mono)"></select></div>
      <button type="button" class="btn btn-dark" id="loadBtn">Load</button>
    </div>
    <div class="pf-status" id="pfStatus"></div>
  </div>

  <form id="tokenForm" style="display:none">
    <input type="hidden" name="uid" id="fUid">

    <!-- Property Details (read-only, double-tap to edit) -->
    <div class="card" id="previewCard">
      <div class="card-title">Property Details</div>
      <div class="card-desc">From visit form. Double-tap to edit on mobile.</div>
      <div class="row2">
        <div class="fg"><label>UID</label><input type="text" id="d_uid" class="pre" readonly></div>
        <div class="fg"><label>City</label><input type="text" id="d_city" class="pre" readonly></div>
      </div>
      <div class="row3">
        <div class="fg"><label>Society</label><input type="text" id="d_soc" class="pre" readonly></div>
        <div class="fg"><label>Locality</label><input type="text" id="d_loc" class="pre" readonly></div>
        <div class="fg"><label>Owner/Broker</label><input type="text" id="d_owner" class="pre" readonly></div>
      </div>
      <div class="row3">
        <div class="fg"><label>Unit</label><input type="text" id="d_unit" class="pre" readonly></div>
        <div class="fg"><label>Floor</label><input type="text" id="d_floor" class="pre" readonly></div>
        <div class="fg"><label>Config</label><input type="text" id="d_config" class="pre" readonly></div>
      </div>
      <div class="fg"><label>Size (sqft)</label><input type="text" id="d_area" class="pre" readonly></div>
    </div>

    <!-- Ownership -->
    <div class="card">
      <div class="card-title">Ownership & Status</div>
      <div class="fg"><label>Co-owner (if any)</label><input type="text" name="co_owner" placeholder="Full name"></div>
      <div class="row2">
        <div class="fg"><label>Registry Status <span class="req">*</span></label><select name="registry_status" required><option value="">Select...</option><option>Registered</option><option>Unregistered</option><option>Under Process</option></select><div class="err-msg">Required</div></div>
        <div class="fg"><label>Occupancy Status <span class="req">*</span></label><select name="occupancy_status" id="d_occ" required><option value="">Select...</option><option>Vacant</option><option>Tenant</option><option>Owner Staying</option></select><div class="err-msg">Required</div></div>
      </div>
      <div class="fg"><label>Inclusions</label><textarea name="inclusions" rows="2" placeholder="AC, Furniture, Fixtures..."></textarea></div>
    </div>

    <!-- Sale Terms -->
    <div class="card">
      <div class="card-title">Sale Terms</div>
      <div class="row2">
        <div class="fg"><label>Guaranteed Sale Price (â‚¹ Lakhs) <span class="req">*</span></label><input type="number" name="guaranteed_sale_price" class="input-md" step="0.01" required><div class="err-msg">Required</div></div>
        <div class="fg"><label>Performance Guarantee (â‚¹) <span class="req">*</span></label><input type="number" name="performance_guarantee" class="input-md" required><div class="err-msg">Required</div></div>
      </div>
      <div class="fg"><label>Full Registry Willingness? <span class="req">*</span></label>
        <div class="radios"><label><input type="radio" name="full_registry_willingness" value="Yes" required><span>Yes</span></label><label><input type="radio" name="full_registry_willingness" value="No"><span>No</span></label></div><div class="err-msg">Required</div></div>
      <div class="row2">
        <div class="fg"><label>Initial Period (Days) <span class="req">*</span></label><input type="number" name="initial_period" class="input-sm" required><div class="err-msg">Required</div></div>
        <div class="fg"><label>Grace Period (Days) <span class="req">*</span></label><input type="number" name="grace_period" class="input-sm" required><div class="err-msg">Required</div></div>
      </div>
      <div class="row2">
        <div class="fg"><label>Rent Payable During Period (â‚¹)</label>
          <div class="na-field"><input type="number" name="rent_payable_period" id="rpp" placeholder="e.g. 25000"><label class="na-toggle"><input type="checkbox" id="rpp_na" onchange="toggleNA('rpp')"><span>N/A</span></label></div></div>
        <div class="fg"><label>Rent During Grace Period (â‚¹)</label>
          <div class="na-field"><input type="number" name="rent_payable_grace_period" id="rpg" placeholder="e.g. 32000"><label class="na-toggle"><input type="checkbox" id="rpg_na" onchange="toggleNA('rpg')"><span>N/A</span></label></div></div>
      </div>
    </div>

    <!-- Loan -->
    <div class="card">
      <div class="card-title">Loan Details</div>
      <div class="fg"><label>Outstanding Loan (â‚¹)</label><input type="number" name="outstanding_loan" class="input-md" placeholder="0 if none"></div>
      <div class="row2">
        <div class="fg"><label>Bank Name (Loan A/c)</label><input type="text" name="bank_name_loan"></div>
        <div class="fg"><label>Loan Account Number</label><input type="text" name="loan_account_number"></div>
      </div>
      <div class="fg"><label>Willing to pay loan?</label>
        <div class="radios"><label><input type="radio" name="loan_pay_willingness" value="Yes"><span>Yes</span></label><label><input type="radio" name="loan_pay_willingness" value="No"><span>No</span></label></div></div>
    </div>

    <!-- Documents -->
    <div class="card">
      <div class="card-title">Documents</div>
      <div class="fg"><label>All papers available? <span class="req">*</span></label>
        <div class="radios"><label><input type="radio" name="papers_available" value="Yes" required><span>Yes</span></label><label><input type="radio" name="papers_available" value="No"><span>No</span></label></div><div class="err-msg">Required</div></div>
      <div class="fg"><label>Documents Available</label><textarea name="documents_available" rows="2" placeholder="Allotment Letter, BBA, Possession Letter..."></textarea></div>
    </div>

    <!-- Remarks -->
    <div class="card"><div class="card-title">Remarks</div><div class="fg"><label>Remarks</label><textarea name="token_remarks" rows="2"></textarea></div></div>

    <!-- Actions -->
    <div class="btn-row" style="border:none;padding:0">
      <button type="button" class="btn btn-amber" id="draftBtn">ðŸ’¾ Save Draft</button>
      <button type="button" class="btn btn-dark" id="submitBtn">Submit & Proceed â†’</button>
    </div>
  </form>
</div>

<script src="/js/shared.js"></script>
<script>
let currentUid=null;

document.addEventListener('DOMContentLoaded', async()=>{
  try{
    const r=await fetch(`${API}/api/visit/uids`);const uids=await r.json();
    const sel=document.getElementById('selUid');sel.innerHTML='<option value="">Select UID...</option>';
    uids.forEach(u=>{sel.innerHTML+=`<option value="${u.uid}">${u.uid} â€” ${u.society_name||''}, ${u.unit_no||''}</option>`});
    makeSearchable(sel);
    const p=new URLSearchParams(location.search);if(p.get('uid')){sel.value=p.get('uid');loadData()}
  }catch(e){toast('Failed to load UIDs','err')}
});

document.getElementById('loadBtn').addEventListener('click',loadData);

async function loadData(){
  const uid=document.getElementById('selUid').value;if(!uid){toast('Select UID','warn');return}
  const st=document.getElementById('pfStatus');st.className='pf-status show';st.textContent='Loading...';
  try{
    const r=await fetch(`${API}/api/token-request/prefill/${uid}`);if(!r.ok)throw new Error((await r.json()).error);
    const d=await r.json();
    document.getElementById('fUid').value=d.uid;
    document.getElementById('d_uid').value=d.uid;document.getElementById('d_city').value=d.city||'';
    document.getElementById('d_soc').value=d.society_name||'';document.getElementById('d_loc').value=d.locality||'';
    document.getElementById('d_owner').value=d.owner_broker_name||'';document.getElementById('d_unit').value=d.unit_no||'';
    document.getElementById('d_floor').value=d.floor??'';document.getElementById('d_config').value=d.configuration||'';
    document.getElementById('d_area').value=d.area_sqft??'';
    // Prefill token fields if previously saved
    if(d.co_owner)document.querySelector('[name="co_owner"]').value=d.co_owner;
    if(d.registry_status)document.querySelector('[name="registry_status"]').value=d.registry_status;
    if(d.occupancy_status)document.getElementById('d_occ').value=d.occupancy_status;
    if(d.guaranteed_sale_price)document.querySelector('[name="guaranteed_sale_price"]').value=d.guaranteed_sale_price;
    if(d.performance_guarantee)document.querySelector('[name="performance_guarantee"]').value=d.performance_guarantee;
    if(d.full_registry_willingness){const rb=document.querySelector(`input[name="full_registry_willingness"][value="${d.full_registry_willingness}"]`);if(rb)rb.checked=true}
    if(d.initial_period)document.querySelector('[name="initial_period"]').value=d.initial_period;
    if(d.grace_period)document.querySelector('[name="grace_period"]').value=d.grace_period;
    if(d.inclusions)document.querySelector('[name="inclusions"]').value=d.inclusions;
    if(d.outstanding_loan)document.querySelector('[name="outstanding_loan"]').value=d.outstanding_loan;
    if(d.bank_name_loan)document.querySelector('[name="bank_name_loan"]').value=d.bank_name_loan;
    if(d.loan_account_number)document.querySelector('[name="loan_account_number"]').value=d.loan_account_number;
    if(d.loan_pay_willingness){const rb=document.querySelector(`input[name="loan_pay_willingness"][value="${d.loan_pay_willingness}"]`);if(rb)rb.checked=true}
    if(d.papers_available){const rb=document.querySelector(`input[name="papers_available"][value="${d.papers_available}"]`);if(rb)rb.checked=true}
    if(d.documents_available)document.querySelector('[name="documents_available"]').value=d.documents_available;
    if(d.token_remarks)document.querySelector('[name="token_remarks"]').value=d.token_remarks;
    if(d.possession_status){const map={'Owner Staying':'Owner Staying','Tenant':'Tenant','Vacant':'Vacant'};if(map[d.possession_status])document.getElementById('d_occ').value=map[d.possession_status]}

    currentUid=uid;
    document.getElementById('tokenForm').style.display='block';
    enableDoubleTapEdit(document.getElementById('previewCard'));
    st.className='pf-status show ok';st.textContent=`âœ“ Loaded: ${uid}${d.token_is_draft?' (Draft)':''}`;
  }catch(e){st.className='pf-status show err';st.textContent=`âœ— ${e.message}`;document.getElementById('tokenForm').style.display='none'}
}

function collectBody(){
  const fd=new FormData(document.getElementById('tokenForm'));const body=Object.fromEntries(fd.entries());
  body.full_registry_willingness=getRadio('full_registry_willingness');
  body.loan_pay_willingness=getRadio('loan_pay_willingness');
  body.papers_available=getRadio('papers_available');
  if(document.getElementById('rpp').dataset.na==='1')body.rent_payable_period='N/A';
  if(document.getElementById('rpg').dataset.na==='1')body.rent_payable_grace_period='N/A';
  return body;
}

// Save Draft â€” no validation
document.getElementById('draftBtn').addEventListener('click',()=>{
  const body=collectBody();body.is_draft=true;
  submitBtn(document.getElementById('draftBtn'),async()=>{
    const r=await fetch(`${API}/api/token-request/submit`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const res=await r.json();if(!r.ok)throw new Error(res.error);
    toast('Draft saved!','ok');
  });
});

// Submit â€” validate required fields
document.getElementById('submitBtn').addEventListener('click',()=>{
  const {valid,missing}=validateForm('tokenForm');
  if(!valid){toast(`Missing: ${missing.slice(0,3).join(', ')}${missing.length>3?'...':''}`,'err');return}
  const body=collectBody();body.is_draft=false;
  submitBtn(document.getElementById('submitBtn'),async()=>{
    const r=await fetch(`${API}/api/token-request/submit`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const res=await r.json();if(!r.ok)throw new Error(res.error);
    toast('Token Request submitted!','ok',5000);
    setTimeout(()=>{if(confirm('Proceed to Final Token Form?'))window.location.href=`/final?uid=${currentUid}`},1500);
  });
});
</script>
</body></html>
