<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Openhouse â€” Token Request</title><link rel="stylesheet" href="/css/styles.css"></head>
<body>
<header class="hdr"><div><div class="logo">OPENHOUSE</div><div class="logo-sub">Token Request Form</div></div></header>
<div class="ctn">
  <div class="card">
    <div class="card-t">Load Property</div>
    <div class="load-row">
      <div class="fg"><label>UID <span class="req">*</span></label><select id="selUid" style="font-family:var(--mono)"></select></div>
      <button type="button" class="btn btn-dark btn-sm" id="loadBtn">Load</button>
    </div>
    <div class="pf-st" id="pfSt"></div>
  </div>

  <form id="tokenForm" style="display:none">
    <input type="hidden" name="uid" id="fUid">

    <!-- Card 1: Property Details (with phone) -->
    <div class="card" id="prevCard">
      <div class="card-t">Property Details</div><div class="card-d">From visit. Double-tap to edit.</div>
      <div class="r2"><div class="fg"><label>UID</label><input type="text" id="d_uid" class="pre" readonly></div>
        <div class="fg"><label>City</label><input type="text" id="d_city" class="pre" readonly></div></div>
      <div class="r2"><div class="fg"><label>Society</label><input type="text" id="d_soc" class="pre" readonly></div>
        <div class="fg"><label>Locality</label><input type="text" id="d_loc" class="pre" readonly></div></div>
      <div class="r2"><div class="fg"><label>Owner/Broker</label><input type="text" id="d_owner" class="pre" readonly></div>
        <div class="fg"><label>Phone</label><input type="text" id="d_phone" class="pre" readonly></div></div>
      <div class="r3"><div class="fg"><label>Unit</label><input type="text" id="d_unit" class="pre" readonly></div>
        <div class="fg"><label>Floor</label><input type="text" id="d_floor" class="pre" readonly></div>
        <div class="fg"><label>Config</label><input type="text" id="d_cfg" class="pre" readonly></div></div>
      <div class="fg"><label>Area (sqft)</label><input type="text" id="d_area" class="pre" readonly></div>
    </div>

    <!-- Card 2: Token Requested -->
    <div class="card">
      <div class="card-t">Token Requested</div>
      <div class="fg"><label>Token Amount (â‚¹) <span class="req">*</span></label><input type="number" name="token_amount_requested" class="input-md" placeholder="e.g. 500000" required><div class="err-msg">Required</div></div>
    </div>

    <!-- Card 3: Deal Terms (renamed from Sale Terms) -->
    <div class="card">
      <div class="card-t">Deal Terms</div>
      <div class="fg"><label>Co-owner (if any)</label><input type="text" name="co_owner"></div>
      <div class="r2"><div class="fg"><label>Registry Status <span class="req">*</span></label><select name="registry_status" required><option value="">Select...</option><option>Registered</option><option>Unregistered</option><option>Under Process</option></select><div class="err-msg">Required</div></div>
        <div class="fg"><label>Occupancy <span class="req">*</span></label><select name="occupancy_status" required><option value="">Select...</option><option>Vacant</option><option>Tenant</option><option>Owner Staying</option></select><div class="err-msg">Required</div></div></div>
      <div class="fg"><label>Inclusions</label><textarea name="inclusions" rows="2" placeholder="AC, Furniture, Fixtures..."></textarea></div>
      <div class="r2"><div class="fg"><label>Initial Period (Days) <span class="req">*</span></label><input type="number" name="initial_period" class="input-sm" required><div class="err-msg">Required</div></div>
        <div class="fg"><label>Grace Period (Days) <span class="req">*</span></label><input type="number" name="grace_period" class="input-sm" required><div class="err-msg">Required</div></div></div>
      <div class="fg"><label>Rent Payable During Initial Period (â‚¹)</label>
        <div class="na-field"><input type="number" name="rent_payable_initial_period" id="rip" placeholder="â‚¹">
          <label class="na-toggle"><input type="checkbox" id="rip_na" onchange="toggleNA('rip','No rent')"><span>No rent payable during initial period</span></label></div></div>
      <div class="fg"><label>Rent Payable During Grace Period (â‚¹)</label>
        <div class="na-field"><input type="number" name="rent_payable_grace_period" id="rgp" placeholder="â‚¹">
          <label class="na-toggle"><input type="checkbox" id="rgp_na" onchange="toggleNA('rgp','No rent')"><span>No rent payable during grace period</span></label></div></div>
    </div>

    <!-- Card 4: Loan Details -->
    <div class="card">
      <div class="card-t">Loan Details</div>
      <div class="fg"><label>Outstanding Loan (â‚¹)</label><input type="number" name="outstanding_loan" class="input-md" placeholder="0 if none"></div>
      <div class="r2"><div class="fg"><label>Bank (Loan A/c)</label><input type="text" name="bank_name_loan"></div>
        <div class="fg"><label>Loan A/c Number</label><input type="text" name="loan_account_number"></div></div>
      <div class="fg"><label>Willing to pay loan?</label>
        <div class="radios"><label><input type="radio" name="loan_pay_willingness" value="Yes"><span>Yes</span></label><label><input type="radio" name="loan_pay_willingness" value="No"><span>No</span></label></div></div>
    </div>

    <!-- Card 5: Documents -->
    <div class="card">
      <div class="card-t">Documents</div>
      <div class="fg"><label>All papers available? <span class="req">*</span></label>
        <div class="radios"><label><input type="radio" name="papers_available" value="Yes" required><span>Yes</span></label><label><input type="radio" name="papers_available" value="No"><span>No</span></label></div><div class="err-msg">Required</div></div>
      <div class="fg"><label>Documents Available</label><div id="docsSelect"></div></div>
      <div class="fg"><label>Remarks</label><textarea name="token_remarks" rows="2"></textarea></div>
    </div>

    <div class="btn-row">
      <button type="button" class="btn btn-amb" id="draftBtn">ðŸ’¾ Save Draft</button>
      <button type="button" class="btn btn-dark" id="submitBtn">Submit â†’</button>
    </div>
  </form>
</div>

<script src="/js/shared.js"></script>
<script>
let docsMsel,currentUid;
document.addEventListener('DOMContentLoaded',async()=>{
  try{
    const r=await fetch(`${API}/api/config`);const opts=(await r.json()).options;
    // Multi-select for documents
    docsMsel=makeMultiSelect(document.getElementById('docsSelect'),'documents_available',opts.documentsAvailable);
    // UIDs
    const ur=await fetch(`${API}/api/token-request/uids`);const uids=await ur.json();
    const sel=document.getElementById('selUid');sel.innerHTML='<option value="">Select UID...</option>';
    uids.forEach(u=>{sel.innerHTML+=`<option value="${u.uid}">${u.uid} â€” ${u.society_name||''}, ${u.unit_no||''}</option>`});
    makeSearchable(sel);
    const p=new URLSearchParams(location.search);if(p.get('uid')){sel.value=p.get('uid');loadData()}
  }catch(e){toast('Failed','err')}
});

document.getElementById('loadBtn').addEventListener('click',loadData);
async function loadData(){
  const uid=document.getElementById('selUid').value;if(!uid){toast('Select UID','warn');return}
  const st=document.getElementById('pfSt');st.className='pf-st show';st.textContent='Loading...';
  try{const r=await fetch(`${API}/api/token-request/prefill/${uid}`);if(!r.ok)throw new Error((await r.json()).error);const d=await r.json();
    document.getElementById('fUid').value=d.uid;currentUid=uid;
    document.getElementById('d_uid').value=d.uid;document.getElementById('d_city').value=d.city||'';
    document.getElementById('d_soc').value=d.society_name||'';document.getElementById('d_loc').value=d.locality||'';
    document.getElementById('d_owner').value=d.owner_broker_name||'';document.getElementById('d_phone').value=d.contact_no||'';
    document.getElementById('d_unit').value=d.unit_no||'';document.getElementById('d_floor').value=d.floor??'';
    document.getElementById('d_cfg').value=d.configuration||'';document.getElementById('d_area').value=d.area_sqft??'';
    // Token fields
    const sv=(n,v)=>{const el=document.querySelector(`[name="${n}"]`);if(el&&v!=null)el.value=v};
    const sr=(n,v)=>{if(!v)return;const rb=document.querySelector(`input[name="${n}"][value="${v}"]`);if(rb)rb.checked=true};
    sv('token_amount_requested',d.token_amount_requested);sv('co_owner',d.co_owner);
    sv('registry_status',d.registry_status);sv('occupancy_status',d.occupancy_status);
    sv('inclusions',d.inclusions);sv('initial_period',d.initial_period);sv('grace_period',d.grace_period);
    if(d.rent_payable_initial_period&&d.rent_payable_initial_period.toUpperCase()==='N/A'){document.getElementById('rip_na').checked=true;toggleNA('rip','No rent')}else sv('rent_payable_initial_period',d.rent_payable_initial_period);
    if(d.rent_payable_grace_period&&d.rent_payable_grace_period.toUpperCase()==='N/A'){document.getElementById('rgp_na').checked=true;toggleNA('rgp','No rent')}else sv('rent_payable_grace_period',d.rent_payable_grace_period);
    sv('outstanding_loan',d.outstanding_loan);sv('bank_name_loan',d.bank_name_loan);sv('loan_account_number',d.loan_account_number);
    sr('loan_pay_willingness',d.loan_pay_willingness);sr('papers_available',d.papers_available);
    sv('token_remarks',d.token_remarks);
    if(d.documents_available){try{docsMsel.setSelected(typeof d.documents_available==='string'?JSON.parse(d.documents_available):d.documents_available)}catch(e){}}
    document.getElementById('tokenForm').style.display='block';
    enableDoubleTapEdit(document.getElementById('prevCard'));
    st.className='pf-st show ok';st.textContent=`âœ“ Loaded: ${uid}${d.token_is_draft?' (Draft)':''}`;
  }catch(e){st.className='pf-st show err';st.textContent=`âœ— ${e.message}`;document.getElementById('tokenForm').style.display='none'}
}

function collectBody(){const fd=new FormData(document.getElementById('tokenForm'));const body=Object.fromEntries(fd.entries());
  body.loan_pay_willingness=getRadio('loan_pay_willingness');body.papers_available=getRadio('papers_available');
  body.documents_available=docsMsel.getSelected();
  if(document.getElementById('rip').dataset.na==='1')body.rent_payable_initial_period='N/A';
  if(document.getElementById('rgp').dataset.na==='1')body.rent_payable_grace_period='N/A';return body}

document.getElementById('draftBtn').addEventListener('click',()=>{const body=collectBody();body.is_draft=true;
  submitBtn(document.getElementById('draftBtn'),async()=>{const r=await fetch(`${API}/api/token-request/submit`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const res=await r.json();if(!r.ok)throw new Error(res.error);toast('Draft saved!','ok')})});

document.getElementById('submitBtn').addEventListener('click',()=>{
  const{valid,missing}=validateForm('tokenForm');if(!valid){toast(`Missing: ${missing.slice(0,3).join(', ')}`,'err');return}
  const body=collectBody();body.is_draft=false;
  submitBtn(document.getElementById('submitBtn'),async()=>{const r=await fetch(`${API}/api/token-request/submit`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const res=await r.json();if(!r.ok)throw new Error(res.error);toast('Submitted!','ok',4000);
    setTimeout(()=>{if(confirm('Proceed to Token & Deal Terms?'))window.location.href=`/token-deal?uid=${currentUid}`},1500)})});
</script>
</body></html>
