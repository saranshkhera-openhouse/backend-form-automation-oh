<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>Openhouse ‚Äî Final Token Form</title><link rel="stylesheet" href="/css/styles.css"></head>
<body>
<header class="header"><div><div class="logo">OPENHOUSE</div><div class="subtitle">Final Token Form ‚Äî PDF Generation</div></div></header>
<div class="container">

  <div class="card">
    <div class="card-title">Select Property UID</div>
    <div class="card-desc">Only UIDs with submitted/draft Token Requests are shown.</div>
    <div class="search-row">
      <div class="fg"><label>UID <span class="req">*</span></label><select id="selUid" style="font-family:var(--mono)"></select></div>
      <button type="button" class="btn btn-dark" id="loadBtn">Load</button>
    </div>
    <div class="pf-status" id="pfStatus"></div>
  </div>

  <form id="finalForm" style="display:none">
    <input type="hidden" name="uid" id="fUid">

    <!-- Property (from Visit) -->
    <div class="card" id="visitCard">
      <div class="card-title">Property Details</div>
      <div class="card-desc">From Visit Form. Double-tap/click to edit.</div>
      <div class="row2">
        <div class="fg"><label>UID</label><input type="text" id="v_uid" class="pre" readonly></div>
        <div class="fg"><label>City</label><input type="text" id="v_city" class="pre" readonly></div>
      </div>
      <div class="row3">
        <div class="fg"><label>Society</label><input type="text" id="v_soc" class="pre" readonly></div>
        <div class="fg"><label>Locality</label><input type="text" id="v_loc" class="pre" readonly></div>
        <div class="fg"><label>Owner/Broker</label><input type="text" id="v_owner" class="pre" readonly></div>
      </div>
      <div class="row3">
        <div class="fg"><label>Unit</label><input type="text" id="v_unit" class="pre" readonly></div>
        <div class="fg"><label>Floor</label><input type="text" id="v_floor" class="pre" readonly></div>
        <div class="fg"><label>Config</label><input type="text" id="v_config" class="pre" readonly></div>
      </div>
      <div class="fg"><label>Size (sqft)</label><input type="text" id="v_area" class="pre" readonly></div>
    </div>

    <!-- Token Request data (editable) -->
    <div class="card">
      <div class="card-title">Ownership & Status</div>
      <div class="fg"><label>Co-owner</label><input type="text" name="co_owner"></div>
      <div class="row2">
        <div class="fg"><label>Registry Status <span class="req">*</span></label><select name="registry_status" required><option value="">Select...</option><option>Registered</option><option>Unregistered</option><option>Under Process</option></select><div class="err-msg">Required</div></div>
        <div class="fg"><label>Occupancy Status <span class="req">*</span></label><select name="occupancy_status" required><option value="">Select...</option><option>Vacant</option><option>Tenant</option><option>Owner Staying</option></select><div class="err-msg">Required</div></div>
      </div>
      <div class="fg"><label>Inclusions</label><textarea name="inclusions" rows="2"></textarea></div>
    </div>

    <div class="card">
      <div class="card-title">Sale Terms</div>
      <div class="row2">
        <div class="fg"><label>Guaranteed Sale Price (‚Çπ Lakhs) <span class="req">*</span></label><input type="number" name="guaranteed_sale_price" class="input-md" step="0.01" required><div class="err-msg">Required</div></div>
        <div class="fg"><label>Performance Guarantee (‚Çπ) <span class="req">*</span></label><input type="number" name="performance_guarantee" class="input-md" required><div class="err-msg">Required</div></div>
      </div>
      <div class="fg"><label>Full Registry Willingness? <span class="req">*</span></label>
        <div class="radios"><label><input type="radio" name="full_registry_willingness" value="Yes" required><span>Yes</span></label><label><input type="radio" name="full_registry_willingness" value="No"><span>No</span></label></div><div class="err-msg">Required</div></div>
      <div class="row2">
        <div class="fg"><label>Initial Period (Days) <span class="req">*</span></label><input type="number" name="initial_period" class="input-sm" required><div class="err-msg">Required</div></div>
        <div class="fg"><label>Grace Period (Days) <span class="req">*</span></label><input type="number" name="grace_period" class="input-sm" required><div class="err-msg">Required</div></div>
      </div>
      <div class="row2">
        <div class="fg"><label>Rent During Period (‚Çπ)</label><div class="na-field"><input type="number" name="rent_payable_period" id="rpp" placeholder="e.g. 25000"><label class="na-toggle"><input type="checkbox" id="rpp_na" onchange="toggleNA('rpp')"><span>N/A</span></label></div></div>
        <div class="fg"><label>Rent During Grace (‚Çπ)</label><div class="na-field"><input type="number" name="rent_payable_grace_period" id="rpg" placeholder="e.g. 32000"><label class="na-toggle"><input type="checkbox" id="rpg_na" onchange="toggleNA('rpg')"><span>N/A</span></label></div></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Loan Details</div>
      <div class="fg"><label>Outstanding Loan (‚Çπ)</label><input type="number" name="outstanding_loan" class="input-md"></div>
      <div class="row2">
        <div class="fg"><label>Bank (Loan A/c)</label><input type="text" name="bank_name_loan"></div>
        <div class="fg"><label>Loan A/c Number</label><input type="text" name="loan_account_number"></div>
      </div>
      <div class="fg"><label>Willing to pay loan?</label>
        <div class="radios"><label><input type="radio" name="loan_pay_willingness" value="Yes"><span>Yes</span></label><label><input type="radio" name="loan_pay_willingness" value="No"><span>No</span></label></div></div>
    </div>

    <div class="card">
      <div class="card-title">Documents</div>
      <div class="fg"><label>All papers available? <span class="req">*</span></label>
        <div class="radios"><label><input type="radio" name="papers_available" value="Yes" required><span>Yes</span></label><label><input type="radio" name="papers_available" value="No"><span>No</span></label></div><div class="err-msg">Required</div></div>
      <div class="fg"><label>Documents</label><textarea name="documents_available" rows="2"></textarea></div>
      <div class="fg"><label>Remarks</label><textarea name="token_remarks" rows="2"></textarea></div>
    </div>

    <!-- NEFT (only here) -->
    <div class="card" style="border-left:3px solid var(--accent2)">
      <div class="card-title">üí≥ NEFT / Payment Details</div>
      <div class="card-desc">This section is exclusive to the Final Token Form.</div>
      <div class="row3">
        <div class="fg"><label>Bank A/C Number <span class="req">*</span></label><input type="text" name="bank_account_number" required><div class="err-msg">Required</div></div>
        <div class="fg"><label>Bank Name <span class="req">*</span></label><input type="text" name="bank_name" required><div class="err-msg">Required</div></div>
        <div class="fg"><label>IFSC Code <span class="req">*</span></label><input type="text" name="ifsc_code" required><div class="err-msg">Required</div></div>
      </div>
      <div class="row3">
        <div class="fg"><label>Token Paid (‚Çπ) <span class="req">*</span></label><input type="number" name="token_paid" class="input-md" required><div class="err-msg">Required</div></div>
        <div class="fg"><label>Transfer Date <span class="req">*</span></label><input type="date" name="token_transfer_date" required><div class="err-msg">Required</div></div>
        <div class="fg"><label>NEFT Reference <span class="req">*</span></label><input type="text" name="neft_reference" required><div class="err-msg">Required</div></div>
      </div>
    </div>

    <!-- Actions -->
    <div class="btn-row" style="border:none;padding:0">
      <button type="button" class="btn btn-dark" id="submitBtn">Submit Final Form</button>
      <div class="tooltip-wrap" id="pdfWrap">
        <button type="button" class="btn btn-green" id="pdfBtn" disabled>üìÑ Preview PDF</button>
        <span class="tooltip-text" id="pdfTooltip">Submit the form first to enable PDF</span>
      </div>
    </div>
  </form>
</div>

<!-- PDF Preview Modal -->
<div class="pdf-modal-overlay" id="pdfModal">
  <div class="pdf-modal">
    <div class="pdf-modal-header"><h3>Token Payment Receipt</h3><button class="btn btn-outline" onclick="closePdfModal()" style="padding:4px 10px;font-size:12px">‚úï Close</button></div>
    <div class="pdf-modal-body"><iframe id="pdfFrame"></iframe></div>
    <div class="pdf-modal-footer"><a id="pdfDownload" class="btn btn-dark" download>‚¨á Download PDF</a></div>
  </div>
</div>

<script src="/js/shared.js"></script>
<script>
let currentUid=null, isSubmitted=false;

document.addEventListener('DOMContentLoaded', async()=>{
  try{
    const r=await fetch(`${API}/api/final/uids`);const uids=await r.json();
    const sel=document.getElementById('selUid');sel.innerHTML='<option value="">Select UID...</option>';
    uids.forEach(u=>{
      const status=u.final_submitted_at?'‚úÖ Final':u.token_is_draft?'üìù Draft':'‚úì Token';
      sel.innerHTML+=`<option value="${u.uid}">${u.uid} ‚Äî ${u.society_name||''}, ${u.unit_no||''} [${status}]</option>`;
    });
    makeSearchable(sel);
    const p=new URLSearchParams(location.search);if(p.get('uid')){sel.value=p.get('uid');loadData()}
  }catch(e){toast('Failed','err')}
});

document.getElementById('loadBtn').addEventListener('click',loadData);

async function loadData(){
  const uid=document.getElementById('selUid').value;if(!uid){toast('Select UID','warn');return}
  const st=document.getElementById('pfStatus');st.className='pf-status show';st.textContent='Loading...';
  try{
    const r=await fetch(`${API}/api/final/prefill/${uid}`);if(!r.ok)throw new Error((await r.json()).error);
    const d=await r.json();
    document.getElementById('fUid').value=d.uid;
    // Visit data
    document.getElementById('v_uid').value=d.uid;document.getElementById('v_city').value=d.city||'';
    document.getElementById('v_soc').value=d.society_name||'';document.getElementById('v_loc').value=d.locality||'';
    document.getElementById('v_owner').value=d.owner_broker_name||'';document.getElementById('v_unit').value=d.unit_no||'';
    document.getElementById('v_floor').value=d.floor??'';document.getElementById('v_config').value=d.configuration||'';
    document.getElementById('v_area').value=d.area_sqft??'';
    // Token request data
    const setVal=(n,v)=>{const el=document.querySelector(`[name="${n}"]`);if(el&&v!=null)el.value=v};
    const setRadio=(n,v)=>{if(!v)return;const rb=document.querySelector(`input[name="${n}"][value="${v}"]`);if(rb)rb.checked=true};
    setVal('co_owner',d.co_owner);setVal('registry_status',d.registry_status);setVal('occupancy_status',d.occupancy_status);
    setVal('inclusions',d.inclusions);setVal('guaranteed_sale_price',d.guaranteed_sale_price);
    setVal('performance_guarantee',d.performance_guarantee);setRadio('full_registry_willingness',d.full_registry_willingness);
    setVal('initial_period',d.initial_period);setVal('grace_period',d.grace_period);
    setVal('outstanding_loan',d.outstanding_loan);setVal('bank_name_loan',d.bank_name_loan);
    setVal('loan_account_number',d.loan_account_number);setRadio('loan_pay_willingness',d.loan_pay_willingness);
    setRadio('papers_available',d.papers_available);setVal('documents_available',d.documents_available);
    setVal('token_remarks',d.token_remarks);
    // Rent payable N/A
    if(d.rent_payable_period&&d.rent_payable_period.toUpperCase()==='N/A'){document.getElementById('rpp_na').checked=true;toggleNA('rpp')}else{setVal('rent_payable_period',d.rent_payable_period)}
    if(d.rent_payable_grace_period&&d.rent_payable_grace_period.toUpperCase()==='N/A'){document.getElementById('rpg_na').checked=true;toggleNA('rpg')}else{setVal('rent_payable_grace_period',d.rent_payable_grace_period)}
    // NEFT (if previously filled)
    setVal('bank_account_number',d.bank_account_number);setVal('bank_name',d.bank_name);
    setVal('ifsc_code',d.ifsc_code);setVal('token_paid',d.token_paid);
    if(d.token_transfer_date)setVal('token_transfer_date',d.token_transfer_date.split('T')[0]);
    setVal('neft_reference',d.neft_reference);

    currentUid=uid;isSubmitted=!!d.final_submitted_at;
    document.getElementById('finalForm').style.display='block';
    enableDoubleTapEdit(document.getElementById('visitCard'));
    updatePdfBtn();
    st.className='pf-status show ok';st.textContent=`‚úì Loaded: ${uid}${d.final_submitted_at?' (Final Submitted)':''}`;
  }catch(e){st.className='pf-status show err';st.textContent=`‚úó ${e.message}`;document.getElementById('finalForm').style.display='none'}
}

function updatePdfBtn(){
  const btn=document.getElementById('pdfBtn'),tip=document.getElementById('pdfTooltip');
  if(isSubmitted){btn.disabled=false;tip.textContent='Click to preview PDF'}
  else{btn.disabled=true;tip.textContent='Submit the form first to enable PDF'}
}

function collectBody(){
  const fd=new FormData(document.getElementById('finalForm'));const body=Object.fromEntries(fd.entries());
  body.full_registry_willingness=getRadio('full_registry_willingness');
  body.loan_pay_willingness=getRadio('loan_pay_willingness');
  body.papers_available=getRadio('papers_available');
  if(document.getElementById('rpp').dataset.na==='1')body.rent_payable_period='N/A';
  if(document.getElementById('rpg').dataset.na==='1')body.rent_payable_grace_period='N/A';
  return body;
}

document.getElementById('submitBtn').addEventListener('click',()=>{
  const {valid,missing}=validateForm('finalForm');
  if(!valid){toast(`Missing: ${missing.slice(0,4).join(', ')}${missing.length>4?'...':''}`,'err');return}
  const body=collectBody();
  submitBtn(document.getElementById('submitBtn'),async()=>{
    const r=await fetch(`${API}/api/final/submit`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const res=await r.json();if(!r.ok)throw new Error(res.error);
    isSubmitted=true;updatePdfBtn();
    toast('Final form submitted! PDF is now available.','ok',6000);
  });
});

document.getElementById('pdfBtn').addEventListener('click',()=>{
  if(!isSubmitted||!currentUid)return;
  const url=`${API}/api/final/pdf/${currentUid}`;
  document.getElementById('pdfFrame').src=url;
  document.getElementById('pdfDownload').href=url;
  document.getElementById('pdfDownload').download=`Token_${currentUid}.pdf`;
  document.getElementById('pdfModal').classList.add('open');
});

function closePdfModal(){document.getElementById('pdfModal').classList.remove('open');document.getElementById('pdfFrame').src=''}
document.getElementById('pdfModal').addEventListener('click',e=>{if(e.target===e.currentTarget)closePdfModal()});
</script>
</body></html>
