<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Openhouse — Visit Form</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>

<header class="header">
  <div><div class="logo">OPENHOUSE</div><div class="subtitle">Visit Form — Ground Staff</div></div>
</header>

<div class="container">
  <div class="stepper">
    <div class="step active" onclick="S.show(1)"><div class="step-num">1</div><span class="step-text">Property</span></div>
    <div class="step-line"></div>
    <div class="step" onclick="S.show(2)"><div class="step-num">2</div><span class="step-text">Amenities</span></div>
    <div class="step-line"></div>
    <div class="step" onclick="S.show(3)"><div class="step-num">3</div><span class="step-text">Facing</span></div>
  </div>

  <form id="form">
    <!-- PAGE 1 -->
    <div class="page active" id="p1">
      <div class="card">
        <div class="card-title">Property Identification</div>
        <div class="card-desc">Basic details captured during the site visit.</div>

        <div class="fg">
          <label>UID <span class="req">*</span></label>
          <input type="text" name="uid" id="uid" placeholder="Enter UID as per company format" required style="font-family:var(--mono);font-size:15px;font-weight:600;letter-spacing:.5px;">
        </div>

        <hr class="div">

        <div class="fg"><label>Source <span class="req">*</span></label><div class="radios" id="srcGroup"></div></div>

        <div class="fg">
          <label>Demand Price (₹ Lakhs) <span class="req">*</span></label>
          <input type="number" name="demand_price" placeholder="e.g. 85.5" step="0.01" required>
        </div>

        <hr class="div">

        <div class="fg"><label>Owner / Broker Name <span class="req">*</span></label><input type="text" name="owner_broker_name" placeholder="Full name" required></div>
        <div class="fg"><label>Owner / Broker Contact No. <span class="req">*</span></label><input type="tel" name="contact_no" placeholder="10-digit mobile" maxlength="10" required></div>

        <hr class="div">

        <!-- City → Society (searchable) → Locality -->
        <div class="row3">
          <div class="fg"><label>City <span class="req">*</span></label><select name="city" id="selCity" required></select></div>
          <div class="fg"><label>Society Name <span class="req">*</span></label><select name="society_name" id="selSoc" required disabled><option value="">Select city first</option></select></div>
          <div class="fg"><label>Locality <span class="req">*</span></label><select name="locality" id="selLoc" required disabled><option value="">Select society first</option></select></div>
        </div>

        <div class="row2">
          <div class="fg"><label>Unit No. <span class="req">*</span></label><input type="text" name="unit_no" placeholder="e.g. B-1204" required></div>
          <div class="fg"><label>Floor <span class="req">*</span></label><input type="number" name="floor" placeholder="e.g. 12" min="0" required></div>
        </div>

        <div class="row2">
          <div class="fg"><label>Configuration <span class="req">*</span></label><select name="configuration" id="selConfig" required></select></div>
          <div class="fg"><label>Area (sqft) <span class="req">*</span></label><input type="number" name="area_sqft" placeholder="e.g. 1450" required></div>
        </div>

        <div class="fg"><label>Extra Area</label><div class="pills" id="extraPills"></div></div>

        <div class="row2">
          <div class="fg"><label>No. of Bathrooms <span class="req">*</span></label><input type="number" name="bathrooms" min="0" required></div>
          <div class="fg"><label>Total Balconies <span class="req">*</span></label><input type="number" name="balconies" min="0" required></div>
        </div>
      </div>
      <div class="btn-row"><div></div><button type="button" class="btn btn-dark" onclick="S.next()">Next →</button></div>
    </div>

    <!-- PAGE 2 -->
    <div class="page" id="p2">
      <div class="card">
        <div class="card-title">Amenities & Features</div>
        <div class="card-desc">Facilities, furnishing, and building details.</div>
        <div class="fg"><label>Gas Pipeline <span class="req">*</span></label><div class="radios" id="gasGroup"></div></div>
        <div class="fg"><label>Possession Status <span class="req">*</span></label><select name="possession_status" id="selPoss" required></select></div>
        <div class="row2">
          <div class="fg"><label>Club Facility <span class="req">*</span></label><div class="radios" id="clubGroup"></div></div>
          <div class="fg"><label>Parking <span class="req">*</span></label><select name="parking" id="selPark" required></select></div>
        </div>
        <div class="fg"><label>Sunlight (1-10) <span class="req">*</span></label><input type="number" name="sunlight" min="1" max="10" required></div>
        <hr class="div">
        <div class="fg"><label>Furnishing <span class="req">*</span></label><select name="furnishing" id="selFurn" required></select></div>
        <div class="fg"><label>Furnishing Details</label><div class="pills" id="furnPills"></div></div>
        <hr class="div">
        <div class="row3">
          <div class="fg"><label>Total Lifts <span class="req">*</span></label><input type="number" name="total_lifts" min="0" required></div>
          <div class="fg"><label>Total Floors (Tower) <span class="req">*</span></label><input type="number" name="total_floors_tower" min="1" required></div>
          <div class="fg"><label>Flats on Floor <span class="req">*</span></label><input type="number" name="total_flats_floor" min="1" required></div>
        </div>
      </div>
      <div class="btn-row">
        <button type="button" class="btn btn-outline" onclick="S.prev()">← Back</button>
        <button type="button" class="btn btn-dark" onclick="S.next()">Next →</button>
      </div>
    </div>

    <!-- PAGE 3 -->
    <div class="page" id="p3">
      <div class="card">
        <div class="card-title">Facing & Balcony Views</div>
        <div class="card-desc">Directions, views, and media links.</div>
        <div class="fg"><label>Exit Facing <span class="req">*</span></label><select name="exit_facing" id="selExit" required></select></div>
        <hr class="div">
        <div class="sub-h">Master Bedroom</div>
        <div class="row2">
          <div class="fg"><label>Balcony Facing</label><select name="master_bedroom_balcony_facing" class="ds"></select></div>
          <div class="fg"><label>Balcony View</label><select name="master_bedroom_balcony_view" class="vs"></select></div>
        </div>
        <div class="fg"><label>Compass Image Link</label><input type="url" name="master_bedroom_compass_link" placeholder="Google Drive link"></div>
        <hr class="div">
        <div class="sub-h">Second Bedroom</div>
        <div class="row2">
          <div class="fg"><label>Balcony Facing</label><select name="second_bedroom_balcony_facing" class="ds"></select></div>
          <div class="fg"><label>Balcony View</label><select name="second_bedroom_balcony_view" class="vs"></select></div>
        </div>
        <div class="fg"><label>Compass Image Link</label><input type="url" name="second_bedroom_compass_link" placeholder="Google Drive link"></div>
        <hr class="div">
        <div class="sub-h">Third Bedroom</div>
        <div class="row2">
          <div class="fg"><label>Balcony Facing</label><select name="third_bedroom_balcony_facing" class="ds"></select></div>
          <div class="fg"><label>Balcony View</label><select name="third_bedroom_balcony_view" class="vs"></select></div>
        </div>
        <div class="fg"><label>Compass Image Link</label><input type="url" name="third_bedroom_compass_link" placeholder="Google Drive link"></div>
        <hr class="div">
        <div class="sub-h">Kitchen</div>
        <div class="row2">
          <div class="fg"><label>Balcony Facing</label><select name="kitchen_balcony_facing" class="ds"></select></div>
          <div class="fg"><label>Balcony View</label><select name="kitchen_balcony_view" class="vs"></select></div>
        </div>
        <hr class="div">
        <div class="sub-h">Living Room</div>
        <div class="row2">
          <div class="fg"><label>Balcony 1 Facing</label><select name="living_room_balcony1_facing" class="ds"></select></div>
          <div class="fg"><label>Balcony 1 View</label><select name="living_room_balcony1_view" class="vs"></select></div>
        </div>
        <div class="row2">
          <div class="fg"><label>Balcony 2 Facing</label><select name="living_room_balcony2_facing" class="ds"></select></div>
          <div class="fg"><label>Balcony 2 View</label><select name="living_room_balcony2_view" class="vs"></select></div>
        </div>
        <hr class="div">
        <div class="fg"><label>Video Link <span class="req">*</span></label><input type="url" name="video_link" placeholder="Google Drive / YouTube link" required></div>
      </div>
      <div class="btn-row">
        <button type="button" class="btn btn-outline" onclick="S.prev()">← Back</button>
        <button type="button" class="btn btn-dark" id="submitBtn">Submit Visit Form</button>
      </div>
    </div>
  </form>
</div>

<script src="/js/shared.js"></script>
<script>
const S = makeStepper(3);
let opts = null;

document.addEventListener('DOMContentLoaded', async () => {
  try {
    const res = await fetch(`${API}/api/config`);
    opts = (await res.json()).options;
    initFields();
    await loadCities(document.getElementById('selCity'));
    setupCascade(
      document.getElementById('selCity'),
      document.getElementById('selSoc'),
      document.getElementById('selLoc')
    );
    // Make society searchable
    makeSearchable(document.getElementById('selSoc'));
  } catch (e) { toast('Failed to load config', 'err'); }
});

function initFields() {
  fillRadios(document.getElementById('srcGroup'), 'source', opts.sources, true);
  fillSelect(document.getElementById('selConfig'), opts.configurations, 'Select Config');
  fillPills(document.getElementById('extraPills'), 'extra_area', opts.extraAreas);
  fillRadios(document.getElementById('gasGroup'), 'gas_pipeline', opts.yesNo, true);
  fillSelect(document.getElementById('selPoss'), opts.possessionStatuses, 'Select Status');
  fillRadios(document.getElementById('clubGroup'), 'club_facility', opts.yesNo, true);
  fillSelect(document.getElementById('selPark'), opts.parkingOptions, 'Select Parking');
  fillSelect(document.getElementById('selFurn'), opts.furnishingLevels, 'Select Level');
  fillPills(document.getElementById('furnPills'), 'furnishing_details', opts.furnishingDetails);
  fillSelect(document.getElementById('selExit'), opts.directions, 'Select Direction');
  document.querySelectorAll('.ds').forEach(s => fillSelect(s, opts.directions, 'Select'));
  document.querySelectorAll('.vs').forEach(s => fillSelect(s, opts.balconyViews, 'Select'));
}

document.getElementById('submitBtn').addEventListener('click', () => {
  const uid = document.getElementById('uid').value.trim();
  if (!uid) { toast('Please enter the UID', 'err'); S.show(1); return; }
  const fd = new FormData(document.getElementById('form'));
  const body = Object.fromEntries(fd.entries());
  body.extra_area = getCheckedJSON('extra_area');
  body.furnishing_details = getCheckedJSON('furnishing_details');
  body.source = getRadio('source');
  body.gas_pipeline = getRadio('gas_pipeline');
  body.club_facility = getRadio('club_facility');

  submitBtn(document.getElementById('submitBtn'), async () => {
    const res = await fetch(`${API}/api/visit/submit`, {
      method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body),
    });
    const result = await res.json();
    if (!res.ok) throw new Error(result.error);
    toast(`Visit submitted! UID: ${result.uid}`, 'ok', 6000);
    setTimeout(() => { if (confirm('Submitted! Start a new visit?')) location.reload(); }, 1200);
  });
});
</script>
</body>
</html>
