<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Openhouse — Token Form</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>

<header class="header">
  <div><div class="logo">OPENHOUSE</div><div class="subtitle">Token Agreement Form</div></div>
</header>

<div class="container">

  <div class="card">
    <div class="card-title">Load Property by UID</div>
    <div class="card-desc">Select a UID from completed visits to auto-populate property details.</div>
    <div class="search-row">
      <div class="fg">
        <label>Property UID <span class="req">*</span></label>
        <select id="selUid" style="font-family:var(--mono);"></select>
      </div>
      <button type="button" class="btn btn-dark" id="loadBtn">Load Data</button>
    </div>
    <div class="pf-status" id="pfStatus"></div>
  </div>

  <form id="tokenForm" style="display:none;">
    <input type="hidden" name="uid" id="fUid">

    <div class="card">
      <div class="card-title">Property Details</div>
      <div class="card-desc">Auto-populated from visit form (read-only).</div>
      <div class="row2">
        <div class="fg"><label>UID</label><input type="text" id="d_uid" class="pre" readonly></div>
        <div class="fg"><label>City</label><input type="text" id="d_city" class="pre" readonly></div>
      </div>
      <div class="row3">
        <div class="fg"><label>Society</label><input type="text" id="d_soc" class="pre" readonly></div>
        <div class="fg"><label>Locality</label><input type="text" id="d_loc" class="pre" readonly></div>
        <div class="fg"><label>Owner / Broker</label><input type="text" id="d_owner" class="pre" readonly></div>
      </div>
      <div class="row3">
        <div class="fg"><label>Unit No.</label><input type="text" id="d_unit" class="pre" readonly></div>
        <div class="fg"><label>Floor</label><input type="text" id="d_floor" class="pre" readonly></div>
        <div class="fg"><label>Configuration</label><input type="text" id="d_config" class="pre" readonly></div>
      </div>
      <div class="fg"><label>Size (sqft)</label><input type="text" id="d_area" class="pre" readonly></div>
    </div>

    <div class="card">
      <div class="card-title">Ownership & Status</div>
      <div class="fg"><label>Co-owner (if any)</label><input type="text" name="co_owner" placeholder="Full name"></div>
      <div class="row2">
        <div class="fg"><label>Registry Status <span class="req">*</span></label>
          <select name="registry_status" required><option value="">Select...</option><option>Registered</option><option>Unregistered</option><option>Under Process</option></select></div>
        <div class="fg"><label>Occupancy Status <span class="req">*</span></label>
          <select name="occupancy_status" id="d_occ" required><option value="">Select...</option><option>Vacant</option><option>Tenant</option><option>Owner Staying</option></select></div>
      </div>
      <div class="fg"><label>Inclusions (AC, Furniture, Fixtures etc.)</label><textarea name="inclusions" rows="2" placeholder="Items included in the sale"></textarea></div>
    </div>

    <div class="card">
      <div class="card-title">Sale Terms</div>
      <div class="row2">
        <div class="fg"><label>Guaranteed Sale Price (₹ Lakhs) <span class="req">*</span></label><input type="number" name="guaranteed_sale_price" step="0.01" required></div>
        <div class="fg"><label>Performance Guarantee (₹) <span class="req">*</span></label><input type="number" name="performance_guarantee" required></div>
      </div>
      <div class="fg"><label>Full Registry Value Willingness? <span class="req">*</span></label>
        <div class="radios">
          <label><input type="radio" name="full_registry_willingness" value="Yes" required><span>Yes</span></label>
          <label><input type="radio" name="full_registry_willingness" value="No"><span>No</span></label>
        </div>
      </div>
      <div class="row2">
        <div class="fg"><label>Initial Period (Days) <span class="req">*</span></label><input type="number" name="initial_period" required></div>
        <div class="fg"><label>Grace Period (Days) <span class="req">*</span></label><input type="number" name="grace_period" required></div>
      </div>

      <!-- Rent Payable with N/A toggles -->
      <div class="row2">
        <div class="fg">
          <label>Rent Payable During Period (₹)</label>
          <div class="na-field">
            <input type="number" name="rent_payable_period" id="rpp" placeholder="e.g. 25000">
            <label class="na-toggle"><input type="checkbox" id="rpp_na" onchange="toggleNA('rpp')"><span>N/A</span></label>
          </div>
        </div>
        <div class="fg">
          <label>Rent Payable During Grace Period (₹)</label>
          <div class="na-field">
            <input type="number" name="rent_payable_grace_period" id="rpg" placeholder="e.g. 32000">
            <label class="na-toggle"><input type="checkbox" id="rpg_na" onchange="toggleNA('rpg')"><span>N/A</span></label>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Loan Details</div>
      <div class="fg"><label>Outstanding Loan Amount (₹)</label><input type="number" name="outstanding_loan" placeholder="0 if no loan"></div>
      <div class="row2">
        <div class="fg"><label>Bank Name (Loan A/c)</label><input type="text" name="bank_name_loan"></div>
        <div class="fg"><label>Loan Account Number</label><input type="text" name="loan_account_number"></div>
      </div>
      <div class="fg"><label>Willing to pay loan on own?</label>
        <div class="radios">
          <label><input type="radio" name="loan_pay_willingness" value="Yes"><span>Yes</span></label>
          <label><input type="radio" name="loan_pay_willingness" value="No"><span>No</span></label>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Documents & Papers</div>
      <div class="fg"><label>All property papers available? <span class="req">*</span></label>
        <div class="radios">
          <label><input type="radio" name="papers_available" value="Yes" required><span>Yes</span></label>
          <label><input type="radio" name="papers_available" value="No"><span>No</span></label>
        </div>
      </div>
      <div class="fg"><label>Documents Available</label><textarea name="documents_available" rows="2" placeholder="Allotment Letter, BBA, Possession Letter, Conveyance Deed..."></textarea></div>
    </div>

    <div class="card">
      <div class="card-title">Payment Details</div>
      <div class="row3">
        <div class="fg"><label>Bank A/C Number <span class="req">*</span></label><input type="text" name="bank_account_number" required></div>
        <div class="fg"><label>Bank Name <span class="req">*</span></label><input type="text" name="bank_name" required></div>
        <div class="fg"><label>IFSC Code <span class="req">*</span></label><input type="text" name="ifsc_code" required></div>
      </div>
      <div class="row3">
        <div class="fg"><label>Token Paid (₹) <span class="req">*</span></label><input type="number" name="token_paid" required></div>
        <div class="fg"><label>Transfer Date <span class="req">*</span></label><input type="date" name="token_transfer_date" required></div>
        <div class="fg"><label>NEFT Reference <span class="req">*</span></label><input type="text" name="neft_reference" required></div>
      </div>
    </div>

    <div class="card">
      <div class="card-title">Remarks</div>
      <div class="fg"><label>Remarks (if any)</label><textarea name="token_remarks" rows="3"></textarea></div>
    </div>

    <div class="btn-row" style="border:none;padding:0;">
      <button type="button" class="btn btn-dark" id="submitBtn">Submit Token Form</button>
      <button type="button" class="btn btn-green" id="pdfBtn" style="display:none;" onclick="downloadPDF()">⬇ Download PDF</button>
    </div>
  </form>
</div>

<script src="/js/shared.js"></script>
<script>
let currentUid = null;

// N/A toggle logic
function toggleNA(fieldId) {
  const inp = document.getElementById(fieldId);
  const cb = document.getElementById(fieldId + '_na');
  if (cb.checked) {
    inp.value = '';
    inp.disabled = true;
    inp.placeholder = 'N/A';
    inp.dataset.na = '1';
  } else {
    inp.disabled = false;
    inp.placeholder = fieldId === 'rpp' ? 'e.g. 25000' : 'e.g. 32000';
    inp.dataset.na = '';
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  try {
    const res = await fetch(`${API}/api/visit/uids`);
    const uids = await res.json();
    const sel = document.getElementById('selUid');
    sel.innerHTML = '<option value="">Select a UID...</option>';
    uids.forEach(u => {
      const lbl = `${u.uid} — ${u.society_name || ''}, ${u.unit_no || ''} (${u.owner_broker_name || ''})`;
      sel.innerHTML += `<option value="${u.uid}">${lbl}</option>`;
    });
    const p = new URLSearchParams(location.search);
    if (p.get('uid')) { sel.value = p.get('uid'); loadData(); }
  } catch (e) { toast('Failed to load UIDs', 'err'); }
});

document.getElementById('loadBtn').addEventListener('click', loadData);

async function loadData() {
  const uid = document.getElementById('selUid').value;
  if (!uid) { toast('Select a UID', 'warn'); return; }
  const st = document.getElementById('pfStatus');
  st.className = 'pf-status show'; st.textContent = 'Loading...';
  try {
    const res = await fetch(`${API}/api/token/prefill/${uid}`);
    if (!res.ok) throw new Error((await res.json()).error);
    const d = await res.json();
    document.getElementById('fUid').value = d.uid;
    document.getElementById('d_uid').value = d.uid;
    document.getElementById('d_city').value = d.city || '';
    document.getElementById('d_loc').value = d.locality || '';
    document.getElementById('d_soc').value = d.society_name || '';
    document.getElementById('d_owner').value = d.owner_broker_name || '';
    document.getElementById('d_unit').value = d.unit_no || '';
    document.getElementById('d_floor').value = d.floor ?? '';
    document.getElementById('d_config').value = d.configuration || '';
    document.getElementById('d_area').value = d.area_sqft ?? '';
    const map = { 'Owner Staying':'Owner Staying', 'Tenant':'Tenant', 'Vacant':'Vacant' };
    if (d.possession_status && map[d.possession_status]) document.getElementById('d_occ').value = map[d.possession_status];
    currentUid = uid;
    document.getElementById('tokenForm').style.display = 'block';
    document.getElementById('pdfBtn').style.display = 'none';
    st.className = 'pf-status show ok'; st.textContent = `✓ Loaded: ${uid}`;
    toast('Data loaded', 'ok');
  } catch (e) {
    st.className = 'pf-status show err'; st.textContent = `✗ ${e.message}`;
    document.getElementById('tokenForm').style.display = 'none';
  }
}

document.getElementById('submitBtn').addEventListener('click', () => {
  const fd = new FormData(document.getElementById('tokenForm'));
  const body = Object.fromEntries(fd.entries());
  body.full_registry_willingness = getRadio('full_registry_willingness');
  body.loan_pay_willingness = getRadio('loan_pay_willingness');
  body.papers_available = getRadio('papers_available');

  // Handle N/A fields
  if (document.getElementById('rpp').dataset.na === '1') body.rent_payable_period = 'N/A';
  if (document.getElementById('rpg').dataset.na === '1') body.rent_payable_grace_period = 'N/A';

  submitBtn(document.getElementById('submitBtn'), async () => {
    const res = await fetch(`${API}/api/token/submit`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
    const result = await res.json();
    if (!res.ok) throw new Error(result.error);
    toast('Token form submitted!', 'ok', 6000);
    document.getElementById('pdfBtn').style.display = 'inline-flex';
  });
});

function downloadPDF() { if (currentUid) window.open(`${API}/api/token/pdf/${currentUid}`, '_blank'); }
</script>
</body>
</html>
