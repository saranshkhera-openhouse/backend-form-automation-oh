<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Openhouse — Admin Dashboard</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>

<header class="header">
  <div><div class="logo">OPENHOUSE</div><div class="subtitle">Admin Dashboard</div></div>
  <div style="display:flex;gap:8px;">
    <a href="/visit" class="btn btn-outline" style="color:#fff;border-color:rgba(255,255,255,.3);font-size:11px;padding:6px 12px;">+ Visit</a>
    <a href="/token" class="btn btn-outline" style="color:#fff;border-color:rgba(255,255,255,.3);font-size:11px;padding:6px 12px;">+ Token</a>
  </div>
</header>

<div class="container wide">

  <div class="stats" id="stats">
    <div class="stat"><div class="stat-val" id="sTotal">—</div><div class="stat-lbl">Total Properties</div></div>
    <div class="stat"><div class="stat-val" id="sVisit">—</div><div class="stat-lbl">Visits Done</div></div>
    <div class="stat"><div class="stat-val" id="sToken">—</div><div class="stat-lbl">Tokens Signed</div></div>
  </div>

  <div class="card" style="padding:0;overflow:hidden;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:14px 18px;border-bottom:1px solid var(--border);">
      <strong style="font-size:14px;">All Properties</strong>
      <button class="btn btn-outline" style="font-size:11px;padding:5px 12px;" onclick="load()">↻ Refresh</button>
    </div>
    <div style="overflow-x:auto;">
      <table class="tbl">
        <thead><tr>
          <th>UID</th><th>City</th><th>Locality</th><th>Society</th><th>Unit</th><th>Config</th><th>Owner</th><th>Visit</th><th>Token</th><th>Actions</th>
        </tr></thead>
        <tbody id="tbody">
          <tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-3);">Loading...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
const API = window.location.origin;

async function load() {
  try {
    const res = await fetch(`${API}/api/properties`);
    const data = await res.json();

    document.getElementById('sTotal').textContent = data.length;
    document.getElementById('sVisit').textContent = data.filter(p => p.visit_submitted_at).length;
    document.getElementById('sToken').textContent = data.filter(p => p.token_submitted_at).length;

    const tbody = document.getElementById('tbody');
    if (!data.length) {
      tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:40px;color:var(--text-3);">No properties yet. <a href="/visit">Create a visit →</a></td></tr>';
      return;
    }

    tbody.innerHTML = data.map(p => `<tr>
      <td style="font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;">${p.uid}</td>
      <td>${p.city || '—'}</td>
      <td>${p.locality || '—'}</td>
      <td>${p.society_name || '—'}</td>
      <td>${p.unit_no || '—'}</td>
      <td>${p.configuration || '—'}</td>
      <td>${[p.owner_first_name, p.owner_last_name].filter(Boolean).join(' ') || '—'}</td>
      <td>${p.visit_submitted_at ? '<span class="badge ok">Done</span>' : '<span class="badge wait">—</span>'}</td>
      <td>${p.token_submitted_at ? '<span class="badge ok">Done</span>' : '<span class="badge wait">Pending</span>'}</td>
      <td>
        <a href="/token?uid=${p.uid}" class="link">Token</a>
        ${p.token_submitted_at ? ' · <a href="/api/token/pdf/' + p.uid + '" class="link" target="_blank">PDF</a>' : ''}
      </td>
    </tr>`).join('');
  } catch (e) { console.error(e); }
}

document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>
